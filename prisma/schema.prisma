generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./visibility.db"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?
  brands    Brand[]
  audits    Audit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Audit {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  domain      String
  status      String   @default("PENDING")
  progress    Int      @default(0)
  message     String?
  results     String   // JSON string
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Brand {
  id              String               @id @default(cuid())
  userId          String
  user            User                 @relation(fields: [userId], references: [id])
  name            String
  primaryDomain   String
  competitors     Competitor[]
  prompts         TrackedPrompt[]
  answers         AiAnswer[]
  snapshots       VisibilitySnapshot[]
  answerPrompts   AnswerPrompt[]
  answerPages     AnswerPage[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

model Competitor {
  id            String   @id @default(cuid())
  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id])
  name          String
  primaryDomain String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AiEngine {
  id          String   @id @default(cuid())
  slug        String   @unique // e.g., "chatgpt", "perplexity"
  displayName String
  answers     AiAnswer[]
  snapshots   VisibilitySnapshot[]
}

model TrackedPrompt {
  id        String     @id @default(cuid())
  brandId   String
  brand     Brand      @relation(fields: [brandId], references: [id])
  text      String
  isActive  Boolean    @default(true)
  answers   AiAnswer[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model AiAnswer {
  id              String        @id @default(cuid())
  brandId         String
  brand           Brand         @relation(fields: [brandId], references: [id])
  trackedPromptId String
  trackedPrompt   TrackedPrompt @relation(fields: [trackedPromptId], references: [id])
  aiEngineId      String
  aiEngine        AiEngine      @relation(fields: [aiEngineId], references: [id])
  rawAnswer       String        // Storing as text for SQLite compatibility
  askedAt         DateTime      @default(now())
  mentions        Mention[]
}

model Mention {
  id               String   @id @default(cuid())
  aiAnswerId       String
  aiAnswer         AiAnswer @relation(fields: [aiAnswerId], references: [id])
  entityType       String   // ENUM("BRAND", "COMPETITOR") - SQLite doesn't support enums
  entityName       String
  isRecommendation Boolean  @default(false)
  sentiment        String   // ENUM("POSITIVE", "NEUTRAL", "NEGATIVE")
}

model VisibilitySnapshot {
  id                     String   @id @default(cuid())
  brandId                String
  brand                  Brand    @relation(fields: [brandId], references: [id])
  aiEngineId             String
  aiEngine               AiEngine @relation(fields: [aiEngineId], references: [id])
  date                   DateTime
  totalAnswers           Int
  brandMentionCount      Int
  competitorMentionCount Int
  brandShareOfVoice      Float
  competitorShareOfVoice String   // JSON string for SQLite
  createdAt              DateTime @default(now())

  @@unique([brandId, aiEngineId, date])
}

// ============================================
// AI Answer Hub & FAQ Generator Models
// ============================================

model AnswerPrompt {
  id          String      @id @default(cuid())
  brandId     String
  brand       Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  question    String
  slug        String
  status      String      @default("DRAFT") // "DRAFT" | "GENERATED" | "PUBLISHED" | "ARCHIVED"
  intent      String      @default("UNKNOWN") // "INFORMATIONAL" | "COMMERCIAL" | "NAVIGATIONAL" | "TRANSACTIONAL" | "UNKNOWN"
  priority    Int         @default(0)
  answerPage  AnswerPage?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([brandId, slug])
  @@index([brandId, status])
}

model AnswerPage {
  id                String              @id @default(cuid())
  brandId           String
  brand             Brand               @relation(fields: [brandId], references: [id], onDelete: Cascade)
  answerPromptId    String              @unique
  answerPrompt      AnswerPrompt        @relation(fields: [answerPromptId], references: [id], onDelete: Cascade)
  title             String
  slug              String
  urlPath           String
  metaDescription   String?
  headlineSnippet   String
  isPublished       Boolean             @default(false)
  publishedAt       DateTime?
  lastGeneratedAt   DateTime?
  lastEditedAt      DateTime?
  sections          AnswerSection[]
  faqItems          AnswerFaqItem[]
  schemaBlocks      AnswerSchemaBlock[]
  metrics           AnswerPageMetricDaily[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([brandId, slug])
  @@index([brandId, isPublished])
}

model AnswerSection {
  id           String     @id @default(cuid())
  answerPageId String
  answerPage   AnswerPage @relation(fields: [answerPageId], references: [id], onDelete: Cascade)
  order        Int
  heading      String
  body         String     // Markdown/plaintext
  type         String     // "INTRO" | "FAQ" | "STEP_BY_STEP" | "COMPARISON" | "SUMMARY" | "OTHER"

  @@index([answerPageId, order])
}

model AnswerFaqItem {
  id           String     @id @default(cuid())
  answerPageId String
  answerPage   AnswerPage @relation(fields: [answerPageId], references: [id], onDelete: Cascade)
  question     String
  answer       String     // Markdown/plaintext

  @@index([answerPageId])
}

model AnswerSchemaBlock {
  id           String     @id @default(cuid())
  answerPageId String
  answerPage   AnswerPage @relation(fields: [answerPageId], references: [id], onDelete: Cascade)
  schemaType   String     // e.g., "FAQPage", "WebPage", "Product"
  language     String     @default("json-ld")
  code         String     // JSON-LD string (TEXT)
  generatedAt  DateTime   @default(now())

  @@index([answerPageId])
}

model AnswerPageMetricDaily {
  id           String     @id @default(cuid())
  answerPageId String
  answerPage   AnswerPage @relation(fields: [answerPageId], references: [id], onDelete: Cascade)
  date         DateTime
  pageViews    Int        @default(0)
  ctaClicks    Int        @default(0)
  aiTargeted   Boolean    @default(false)

  @@unique([answerPageId, date])
  @@index([answerPageId, date])
}

